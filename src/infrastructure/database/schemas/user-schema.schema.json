{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://dependency-linker.io/schemas/user-schema.json",
  "title": "Dependency Linker User Schema",
  "description": "JSON Schema specification for user-friendly database configuration",
  "version": "2.0.0",
  
  "type": "object",
  "required": ["version", "metadata", "databases"],
  
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version following semantic versioning"
    },
    
    "metadata": {
      "type": "object",
      "required": ["name", "description"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "maxLength": 500
        },
        "author": {
          "type": "string",
          "maxLength": 100
        },
        "lastUpdated": {
          "type": "string",
          "format": "date"
        }
      },
      "additionalProperties": false
    },
    
    "databases": {
      "type": "object",
      "minProperties": 1,
      "patternProperties": {
        "^[a-z][a-z0-9_]*$": {
          "$ref": "#/definitions/Database"
        }
      },
      "additionalProperties": false
    }
  },
  
  "definitions": {
    "Database": {
      "type": "object",
      "required": ["display_name", "description", "properties"],
      "properties": {
        "display_name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "maxLength": 300
        },
        "icon": {
          "type": "string",
          "pattern": "^.{1,2}$",
          "description": "Single emoji character"
        },
        "category": {
          "type": "string",
          "enum": ["core", "relationship", "external", "code", "system"]
        },
        "properties": {
          "type": "object",
          "minProperties": 0,
          "patternProperties": {
            "^[a-z][a-z0-9_]*$": {
              "$ref": "#/definitions/Property"
            }
          },
          "additionalProperties": false
        },
        "relationships": {
          "type": "object",
          "patternProperties": {
            "^[a-z][a-z0-9_]*$": {
              "$ref": "#/definitions/Relationship"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    
    "Property": {
      "oneOf": [
        { "$ref": "#/definitions/TextProperty" },
        { "$ref": "#/definitions/NumberProperty" },
        { "$ref": "#/definitions/SelectProperty" },
        { "$ref": "#/definitions/CheckboxProperty" },
        { "$ref": "#/definitions/DateProperty" },
        { "$ref": "#/definitions/MetricsGroup" }
      ]
    },
    
    "TextProperty": {
      "type": "object",
      "required": ["type", "display_name"],
      "properties": {
        "type": { "const": "text" },
        "display_name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "required": { "type": "boolean", "default": false },
        "searchable": { "type": "boolean", "default": false },
        "multiline": { "type": "boolean", "default": false }
      },
      "additionalProperties": false
    },
    
    "NumberProperty": {
      "type": "object",
      "required": ["type", "display_name"],
      "properties": {
        "type": { "const": "number" },
        "display_name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "format": {
          "type": "string",
          "enum": ["number", "currency", "percent", "bytes"]
        },
        "min": { "type": "number" },
        "max": { "type": "number" }
      },
      "additionalProperties": false
    },
    
    "SelectProperty": {
      "type": "object",
      "required": ["type", "display_name", "options"],
      "properties": {
        "type": { "const": "select" },
        "display_name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "required": { "type": "boolean", "default": false },
        "auto_detect": { "type": "boolean", "default": false },
        "default": { "type": "string" },
        "options": {
          "type": "array",
          "minItems": 1,
          "maxItems": 100,
          "items": {
            "type": "object",
            "required": ["value", "label"],
            "properties": {
              "value": { "type": "string", "minLength": 1 },
              "label": { "type": "string", "minLength": 1 },
              "color": {
                "type": "string",
                "enum": [
                  "default", "gray", "brown", "orange", "yellow", 
                  "green", "blue", "purple", "pink", "red"
                ]
              },
              "description": { "type": "string" }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    
    "CheckboxProperty": {
      "type": "object",
      "required": ["type", "display_name"],
      "properties": {
        "type": { "const": "checkbox" },
        "display_name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "default": { "type": "boolean", "default": false }
      },
      "additionalProperties": false
    },
    
    "DateProperty": {
      "type": "object",
      "required": ["type", "display_name"],
      "properties": {
        "type": { "const": "date" },
        "display_name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "include_time": { "type": "boolean", "default": false },
        "auto_update": { "type": "boolean", "default": false }
      },
      "additionalProperties": false
    },
    
    "MetricsGroup": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "const": "metrics" },
        "display_name": { "type": "string", "default": "Metrics" },
        "description": { "type": "string" }
      },
      "patternProperties": {
        "^[a-z][a-z0-9_]*$": {
          "$ref": "#/definitions/NumberProperty"
        }
      },
      "additionalProperties": false
    },
    
    "Relationship": {
      "type": "object",
      "required": ["target", "type", "display_name"],
      "properties": {
        "target": {
          "type": "string",
          "anyOf": [
            {
              "pattern": "^[a-z][a-z0-9_]*$",
              "description": "Target database name"
            },
            {
              "enum": ["self"],
              "description": "Self-reference to the same database"
            }
          ]
        },
        "type": {
          "type": "string",
          "enum": ["one_to_one", "one_to_many", "many_to_one", "many_to_many"]
        },
        "display_name": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "required": { "type": "boolean", "default": false },
        "reference_type": {
          "type": "string",
          "enum": ["database", "self"],
          "description": "Type of reference: database (cross-database) or self (same database)",
          "default": "database"
        },
        "bidirectional": {
          "type": "object",
          "required": ["reverse_name"],
          "properties": {
            "reverse_name": { "type": "string", "minLength": 1 },
            "reverse_description": { "type": "string" },
            "auto_generate": { 
              "type": "boolean", 
              "default": true,
              "description": "Automatically create reverse relationship property"
            },
            "reverse_type": {
              "type": "string",
              "enum": ["one_to_one", "one_to_many", "many_to_one", "many_to_many"],
              "description": "Override relationship type for reverse direction"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  
  "additionalProperties": false
}