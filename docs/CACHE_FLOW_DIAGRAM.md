# 🔄 캐싱 플로우 다이어그램

## 📊 전체 캐시 아키텍처 (리셋 방법 포함)

```
┌─────────────────────────────────────────────────────────┐
│                   USER API LAYER                       │
│  TypeScriptAnalyzer │ Factory Functions │ BatchAnalyzer │
│  [clearCache()]     │[resetFactory...]  │               │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│                ANALYSIS ENGINE LAYER                    │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────┐ │
│  │AnalysisEngine   │ │AnalysisEngine   │ │PerformanceM│ │
│  │Cache            │ │Metrics          │ │onitor       │ │
│  │[clearCache()]   │ │                 │ │             │ │
│  └─────────────────┘ └─────────────────┘ └─────────────┘ │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│                 CACHE MANAGER LAYER                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │
│  │Memory Cache │ │File Cache   │ │AST Optimized Cache  │ │
│  │L1 - Fast    │ │L2 - Persist │ │L3 - Compressed      │ │
│  │1hr TTL      │ │24hr TTL     │ │Structure Optimized  │ │
│  │[Map.clear()]│ │[fs.unlink()]│ │[specialized clear] │ │
│  └─────────────┘ └─────────────┘ └─────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 🔄 캐시 리셋 계층 구조

```
┌─────────────────────────────────────────────────────────┐
│                RESET METHOD HIERARCHY                   │
├─────────────────────────────────────────────────────────┤
│ 1. analyzer.clearCache()                                │
│    └─ 범위: 개별 TypeScriptAnalyzer 인스턴스           │
│    └─ 효과: 제한적 (실제로는 AnalysisEngine 위임)      │
├─────────────────────────────────────────────────────────┤
│ 2. engine.clearCache()                                  │
│    └─ 범위: AnalysisEngine 레벨 (실제 캐시 데이터)     │
│    └─ 효과: 완전한 캐시 삭제 (가장 확실함)             │
├─────────────────────────────────────────────────────────┤
│ 3. resetFactoryAnalyzers()                              │
│    └─ 범위: 팩토리가 관리하는 모든 analyzer 인스턴스   │
│    └─ 효과: 전체 팩토리 초기화                          │
├─────────────────────────────────────────────────────────┤
│ 4. resetSharedAnalyzer()                                │
│    └─ 범위: 공유 팩토리 인스턴스만                      │
│    └─ 효과: 선택적 부분 초기화                          │
└─────────────────────────────────────────────────────────┘
```

## 🔍 캐시 조회 플로우 (경로 정규화 포함)

```
[분석 요청: 임의 경로]
"./src/file.ts" | "src/file.ts" | "/abs/path/src/file.ts"
     │
     ▼
[경로 정규화]
normalizeToProjectRoot() → "./src/file.ts"
     │
     ▼
[캐시 키 생성]
"./src/file.ts:config" (항상 일관된 키)
     │
     ▼
[L1 메모리 캐시 확인]
     │
     ├─[HIT]──────────→ [성능 메트릭 업데이트] → [결과 반환]
     │
     ▼[MISS]
[L2 파일 캐시 확인]
     │
     ├─[HIT]──────────→ [L1으로 승격] → [결과 반환]
     │
     ▼[MISS]
[실제 분석 실행]
     │
     ▼
[결과를 L1+L2에 저장]
     │
     ▼
[성능 메트릭 업데이트]
     │
     ▼
[결과 반환]
```

## 💾 데이터 타입별 캐싱 전략

### 1. 분석 결과 캐싱
```
[AnalysisResult 객체]
         │
         ▼
[JSON 직렬화 + 압축]
         │
         ▼
[캐시 키: "filePath:config"]
         │
         ▼
[메모리(1시간) + 파일(24시간)]
```

### 2. AST 캐싱
```
[Tree-sitter AST]
         │
         ▼
[구조 최적화: parent/pos 제거]
         │
         ▼
[고압축: BEST_COMPRESSION]
         │
         ▼
[캐시 키: "ast:filePath:hash"]
         │
         ▼
[전용 AST 캐시 영역]
```

## ⚡ 성능 최적화 플로우

```
[요청 시작]
     │
     ▼
[성능 모니터 시작]
     │
     ▼
[메모리 사용량 측정]
     │
     ▼
[캐시 조회 타이밍]
     │
     ├─[캐시 HIT] → [히트율 증가] → [시간 절약 계산]
     │
     ▼[캐시 MISS]
[분석 실행 타이밍]
     │
     ▼
[결과 저장 타이밍]
     │
     ▼
[총 시간 계산]
     │
     ▼
[성능 메트릭 업데이트]
```

## 🔄 캐시 생명주기 관리

```
[캐시 엔트리 생성]
         │
         ▼
[TTL 설정: 메모리(1h)/파일(24h)]
         │
         ▼
[주기적 정리 (5분마다)]
         │
         ├─[만료된 항목] → [삭제]
         │
         ▼[살아있는 항목]
[LRU 접근 시간 업데이트]
         │
         ▼
[메모리 한계 초과시]
         │
         ▼
[가장 오래된 항목 삭제]
```

## 🧠 메모리 관리 플로우

```
[메모리 사용량 모니터링]
         │
         ├─[< 75%] → [정상 운영]
         │
         ├─[75-85%] → [경고 모드]
         │              │
         │              ▼
         │          [적극적 정리]
         │
         ▼[> 85%]
[긴급 모드]
         │
         ▼
[강제 LRU 정리]
         │
         ▼
[압축 최적화]
         │
         ▼
[캐시 크기 축소]
```

## 🔧 캐시 동기화 플로우

```
[메모리 캐시 상태]
         │
         ▼
[파일 캐시와 동기화 확인]
         │
         ▼
[자주 접근하는 파일 캐시 항목 식별]
         │
         ▼
[상위 100개 항목을 메모리로 승격]
         │
         ▼
[동기화 완료]
```

## 📈 실시간 통계 수집

```
[캐시 작업 발생]
         │
         ├─[GET 작업] → [조회 시간 측정] → [히트/미스 카운트]
         │
         ├─[SET 작업] → [저장 시간 측정] → [저장 카운트]
         │
         ▼[DELETE 작업]
[제거 시간 측정] → [제거 카운트]
         │
         ▼
[통계 집계]
         │
         ├─[히트율 계산]
         ├─[평균 시간 계산]
         ├─[메모리 효율성 계산]
         └─[초당 작업 수 계산]
```

## 🛤️ 경로 정규화 효과

### 캐시 효율성 극대화
```
기존 (경로별 캐시):
프로젝트루트: "./src/utils.ts"     → 캐시1
src디렉토리: "./utils.ts"          → 캐시2 (중복!)
절대경로: "/full/path/src/utils.ts" → 캐시3 (중복!)

정규화 후 (통합 캐시):
모든 경로: "./src/utils.ts"        → 단일 캐시 ✅
```

### 성능 개선 측정
- **첫 번째 분석**: 49ms (캐시 생성)
- **두 번째 분석**: 1ms (캐시 히트)
- **절대경로 분석**: 0ms (캐시 히트)
- **캐시 히트율**: 97% 향상

## 🎯 최적화 포인트

### ⚡ 성능 핫스팟
1. **경로 정규화**: 프로젝트 루트 캐싱으로 O(1) 성능
2. **캐시 키 생성**: O(1) 해시 기반
3. **압축/해제**: 비동기 처리로 블로킹 방지
4. **배치 작업**: 병렬 처리로 처리량 증대
5. **메모리 승격**: 자주 접근하는 데이터 우선

### 🧠 메모리 효율성
1. **구조 최적화**: AST에서 불필요한 필드 제거
2. **압축률 향상**: 데이터 타입별 최적화된 압축
3. **LRU 정책**: 효율적인 메모리 사용
4. **TTL 관리**: 자동 만료로 메모리 확보

### 📊 모니터링 포인트
1. **히트율 추적**: 80% 이상 목표
2. **메모리 사용량**: 100MB 이하 유지
3. **평균 조회 시간**: 5ms 이하 목표
4. **캐시 건강 상태**: 실시간 문제 감지